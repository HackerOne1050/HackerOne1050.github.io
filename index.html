<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Bomba Control Global</title>
<style>
  body {
    margin: 0; font-family: Arial, sans-serif; 
    background-color: #0b0f14; color: #fff;
    display: flex; justify-content: center; align-items: center;
    height: 100vh; flex-direction: column;
    transition: background 0.8s;
  }
  .hidden { display: none; }
  button {
    margin: 8px; padding: 12px 18px; border: none; border-radius: 8px;
    font-weight: bold; cursor: pointer; color: #fff;
  }
  #bombaBtn { background: linear-gradient(90deg,#7b0f0f,#ff5252); }
  #controlBtn { background: linear-gradient(90deg,#0b5a85,#0bb7ff); }
  #timer { font-size: 100px; margin: 20px 0; }
  #status { font-size: 28px; color: #9aa6b2; margin-top: 10px; }
  #controlPanel button { background: rgba(255,255,255,0.15); }
  #win { color: #00ff90; font-size: 38px; }
  #lose { color: #ff4040; font-size: 38px; }
</style>
</head>
<body>

<div id="selector">
  <h1>Selecciona tu rol</h1>
  <button id="bombaBtn">Bomba</button>
  <button id="controlBtn">Control</button>
</div>

<div id="bombaView" class="hidden">
  <div id="timer">05:00</div>
  <div id="status">Esperando...</div>
</div>

<div id="controlView" class="hidden">
  <div id="timer">05:00</div>
  <div id="status">Modo Control</div>
  <div id="controlPanel">
    <button id="minusBtn">-1:00</button>
    <button id="plusBtn">+1:30</button>
    <button id="resetBtn">Reiniciar</button>
  </div>
</div>

<!-- Firebase -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
  import { getDatabase, ref, set, onValue, update } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-database.js";

  const firebaseConfig = {
    apiKey: "AIzaSyCcgyGXqbykaTrJvQRwgqkYSrFAUL-ob-8",
    authDomain: "bombacontrol-363e8.firebaseapp.com",
    databaseURL: "https://bombacontrol-363e8-default-rtdb.firebaseio.com",
    projectId: "bombacontrol-363e8",
    storageBucket: "bombacontrol-363e8.firebasestorage.app",
    messagingSenderId: "387694346907",
    appId: "1:387694346907:web:4a8b90e3bf25c1cd277c3e",
    measurementId: "G-CXLEEKDE3J"
  };

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);
  const timerRef = ref(db, 'timer');

  let role = null;
  let ticking = null;

  function formatTime(sec) {
    if (sec < 0) sec = 0;
    const m = Math.floor(sec / 60);
    const s = sec % 60;
    return `${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
  }

  // Inicializa Firebase si est√° vac√≠o
  set(timerRef, { time: 300, running: false, result: "" });

  // Escuchar cambios globales
  onValue(timerRef, snapshot => {
    const data = snapshot.val();
    if (!data) return;
    const { time, result } = data;
    document.querySelectorAll("#timer").forEach(t => t.textContent = formatTime(time));

    if (result === "win") {
      document.body.style.background = "#003b17";
      document.getElementById("status").innerHTML = "<span id='win'>üèÜ GANASTE, bomba desactivada</span>";
    } else if (result === "lose") {
      document.body.style.background = "#3b0000";
      document.getElementById("status").innerHTML = "<span id='lose'>üí• PERDISTE, la bomba explot√≥</span>";
    } else {
      document.body.style.background = "#0b0f14";
      if (role === "bomba") document.getElementById("status").textContent = "Tiempo restante...";
      if (role === "control") document.getElementById("status").textContent = "Modo Control";
    }
  });

  async function startCountdown() {
    if (ticking) clearInterval(ticking);
    ticking = setInterval(async () => {
      const resp = await fetch(`${firebaseConfig.databaseURL}/timer.json`);
      const data = await resp.json();
      if (!data || data.result) return;

      let time = data.time - 1;
      if (time <= 0) {
        await set(timerRef, { time: 0, running: false, result: "lose" });
        clearInterval(ticking);
        return;
      }
      if (time >= 600) {
        await set(timerRef, { time: 600, running: false, result: "win" });
        clearInterval(ticking);
        return;
      }
      await update(timerRef, { time });
    }, 1000);
  }

  document.getElementById("bombaBtn").addEventListener("click", async () => {
    role = "bomba";
    document.getElementById("selector").classList.add("hidden");
    document.getElementById("bombaView").classList.remove("hidden");

    const resp = await fetch(`${firebaseConfig.databaseURL}/timer.json`);
    const data = await resp.json();
    if (!data.running) {
      await set(timerRef, { time: 300, running: true, result: "" });
      startCountdown();
    } else startCountdown();
  });

  document.getElementById("controlBtn").addEventListener(() => {
    role = "control";
    document.getElementById("selector").classList.add("hidden");
    document.getElementById("controlView").classList.remove("hidden");
  });

  document.getElementById("minusBtn").addEventListener("click", async () => {
    const resp = await fetch(`${firebaseConfig.databaseURL}/timer.json`);
    const data = await resp.json();
    if (data.result) return;
    let newTime = data.time - 60;
    if (newTime < 0) newTime = 0;
    await update(timerRef, { time: newTime });
  });

  document.getElementById("plusBtn").addEventListener("click", async () => {
    const resp = await fetch(`${firebaseConfig.databaseURL}/timer.json`);
    const data = await resp.json();
    if (data.result) return;
    let newTime = data.time + 90;
    if (newTime > 600) newTime = 600;
    await update(timerRef, { time: newTime });
  });

  document.getElementById("resetBtn").addEventListener("click", async () => {
    await set(timerRef, { time: 300, running: true, result: "" });
    startCountdown();
  });

  startCountdown();
</script>
</body>
</html>

